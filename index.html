<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TB200 Performance Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 200px; }
    #result { margin-top: 2rem; font-weight: bold; }
    :root {
      color-scheme: light;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 2rem;
      background-color: #f9fbff;
      color: #1b2733;
    }

    h1 {
      margin-bottom: 0.35rem;
    }

    .version {
      margin-top: 0;
      color: #586a7a;
    }

    #layout {
      display: flex;
      flex-wrap: wrap;
      gap: 2.5rem;
      align-items: flex-start;
    }

    #calculationPanel {
      flex: 1 1 360px;
      max-width: 720px;
      background: #ffffff;
      border-radius: 16px;
      padding: 1.75rem;
      box-shadow: 0 18px 40px rgba(15, 35, 95, 0.12);
      border: 1px solid rgba(48, 77, 146, 0.12);
    }

    #perfForm {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    .form-control {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    label {
      font-weight: 600;
    }

    input[type="number"],
    select {
      padding: 0.55rem 0.7rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(27, 39, 51, 0.25);
      background-color: #fff;
      transition: border-color 0.2s ease;
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #2e63ff;
      box-shadow: 0 0 0 3px rgba(46, 99, 255, 0.15);
    }

    .button-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button {
      padding: 0.65rem 1.6rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #calcBtn {
      background: linear-gradient(135deg, #2f66ff, #1d46cc);
      color: #fff;
      box-shadow: 0 10px 18px rgba(47, 102, 255, 0.28);
    }

    #detailsBtn {
      background: #e6ecff;
      color: #1d46cc;
      box-shadow: 0 8px 16px rgba(33, 61, 158, 0.12);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 22px rgba(33, 61, 158, 0.18);
    }

    #result {
      margin-top: 1.75rem;
      font-weight: 600;
      color: #1d46cc;
    }

    #details {
      margin-top: 1.5rem;
      background: linear-gradient(180deg, rgba(230, 236, 255, 0.7), rgba(255, 255, 255, 0.9));
      border-radius: 14px;
      border: 1px solid rgba(48, 77, 146, 0.18);
      padding: 1.25rem 1.4rem;
      box-shadow: inset 0 10px 22px rgba(79, 104, 158, 0.08);
    }

    #details.hidden {
      display: none;
    }

    #details p {
      margin: 0.4rem 0;
      line-height: 1.45;
    }

    #visualization {
      flex: 0 0 280px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      background: linear-gradient(200deg, rgba(255, 255, 255, 0.92), rgba(226, 233, 255, 0.88));
      border-radius: 18px;
      padding: 1.75rem 1.5rem;
      box-shadow: 0 18px 40px rgba(12, 34, 93, 0.16);
      border: 1px solid rgba(48, 77, 146, 0.16);
    }

    #visualization h2 {
      margin: 0;
      font-size: 1.15rem;
      letter-spacing: 0.02em;
      color: #1d2c48;
    }

    #windIndicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
    }

    #windCircle {
      width: 180px;
      height: 180px;
      border: 3px solid rgba(31, 58, 147, 0.85);
      border-radius: 50%;
      position: relative;
      background: radial-gradient(circle at 50% 50%, #ffffff 0%, #e6ecff 68%, #d6e0ff 100%);
      box-shadow: inset 0 14px 26px rgba(28, 50, 122, 0.18);
    }

    #windCircle::before,
    #windCircle::after {
      content: "";
      position: absolute;
      background: rgba(31, 58, 147, 0.25);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    #windCircle::before {
      width: 2px;
      height: 160px;
    }

    #windCircle::after {
      width: 160px;
      height: 2px;
    }

    #windArrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      transform: translate(-50%, -50%) rotate(0deg);
      transform-origin: center;
      transition: transform 0.25s ease;
    }

    #windArrow::before {
      content: "";
      position: absolute;
      width: 6px;
      height: 74px;
      left: -3px;
      top: -74px;
      background: linear-gradient(180deg, #1f3a93, #3456d1);
      border-radius: 3px;
      box-shadow: 0 6px 18px rgba(31, 58, 147, 0.4);
    }

    #windArrow::after {
      content: "";
      position: absolute;
      top: -92px;
      left: -12px;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 20px solid #1f3a93;
      filter: drop-shadow(0 4px 6px rgba(31, 58, 147, 0.25));
    }

    #relativeWindAngleText {
      margin: 0;
      font-weight: 600;
      color: #1d2c48;
      text-align: center;
    }

    #runwayContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    #runway {
      width: 110px;
      height: 320px;
      background: linear-gradient(180deg, #5f646d 0%, #737b87 100%);
      border-radius: 18px;
      position: relative;
      border: 3px solid rgba(25, 27, 30, 0.75);
      box-shadow: inset 0 20px 30px rgba(0, 0, 0, 0.25);
    }

    #runway::before {
      content: "";
      position: absolute;
      top: 6%;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 88%;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.95) 0,
        rgba(255, 255, 255, 0.95) 26px,
        rgba(255, 255, 255, 0) 26px,
        rgba(255, 255, 255, 0) 48px
      );
      border-radius: 7px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.25);
    }

    .runway-label {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #1d2c48;
    }

    @media (max-width: 1024px) {
      #layout {
        flex-direction: column;
        align-items: stretch;
      }

      #visualization {
        flex-direction: row;
        justify-content: space-around;
        padding: 1.4rem 1.2rem;
      }

      #visualization h2 {
        align-self: flex-start;
      }
    }

    @media (max-width: 640px) {
      body {
        margin: 1rem;
      }

      #calculationPanel {
        padding: 1.35rem;
      }

      #visualization {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>TB200 Performance Calculator</h1>
  <p>Version 1.1</p>
  <form id="perfForm">
    <label for="qnh">QNH (hPa)</label>
      <input
        type="number"
        id="qnh"
        name="qnh"
        value="1013"
        min="700"
        max="1300"
      />

    <label for="temperature">Temperatur (°C)</label>
      <input
        type="number"
        id="temperature"
        name="temperature"
        value="15"
        min="-100"
        max="200"
      />

    <label for="windSpeed">Windgeschwindigkeit (kt)</label>
      <input
        type="number"
        id="windSpeed"
        name="windSpeed"
        min="0"
        max="100"
      />

    <label for="windDirection">Windrichtung (°)</label>
      <input
        type="number"
        id="windDirection"
        name="windDirection"
        min="0"
        max="360"
      />

    <label for="surface">Pistenoberfläche</label>
    <select id="surface" name="surface">
      <option value="grass">Gras</option>
      <option value="asphalt">Asphalt</option>
      <option value="concrete">Beton</option>
    </select>

    <label for="runwayHeading">Pistenausrichtung (°)</label>
      <input
        type="number"
        id="runwayHeading"
        name="runwayHeading"
        value="55"
        min="0"
        max="360"
      />

    <label for="fieldElevation">Flugplatzhöhe (ft)</label>
      <input
        type="number"
        id="fieldElevation"
        name="fieldElevation"
        value="1535"
        min="0"
        max="15000"
      />

    <button type="button" id="calcBtn">Berechnen</button>
    <button type="button" id="detailsBtn">Detaillierte Berechnung</button>
  </form>

  <div id="result"></div>

  <div id="details" style="display: none;">
    <p id="isaDeviation">ISA Abweichung: --</p>
    <p id="windComponent">Head/Tailwind Komponente: --</p>
    <p id="calcPressureAltitude">Druckhöhe: --</p>
    <p id="distancePressureAltitude">Strecke nach Druckhöhe (ISA=0): --</p>
  <p class="version">Version 1.9</p>
  <div id="layout">
    <div id="calculationPanel">
      <form id="perfForm" novalidate>
        <div class="form-control">
          <label for="qnh">QNH (hPa)</label>
          <input
            type="number"
            id="qnh"
            name="qnh"
            value="1013"
            min="700"
            max="1300"
            required
          />
        </div>

        <div class="form-control">
          <label for="temperature">Temperatur (°C)</label>
          <input
            type="number"
            id="temperature"
            name="temperature"
            value="15"
            min="-100"
            max="200"
            required
          />
        </div>

        <div class="form-control">
          <label for="windSpeed">Windgeschwindigkeit (kt)</label>
          <input
            type="number"
            id="windSpeed"
            name="windSpeed"
            value="0"
            min="0"
            max="100"
            required
          />
        </div>

        <div class="form-control">
          <label for="windDirection">Windrichtung (°)</label>
          <input
            type="number"
            id="windDirection"
            name="windDirection"
            value="0"
            min="0"
            max="360"
            required
          />
        </div>

        <div class="form-control">
          <label for="surface">Pistenoberfläche</label>
          <select id="surface" name="surface">
            <option value="asphalt">Asphalt</option>
            <option value="concrete">Beton</option>
            <option value="hard-grass">Harter Rasen</option>
            <option value="short-grass">Kurzes Gras</option>
            <option value="long-grass">Hohes Gras</option>
            <option value="short-wet-grass-firm">Kurzes feuchtes Gras auf festem Gelände</option>
            <option value="loose-soft">Lockeres Gelände, Schlamm oder Schnee</option>
          </select>
        </div>

        <div class="form-control">
          <label for="runwayHeading">Pistenausrichtung (°)</label>
          <input
            type="number"
            id="runwayHeading"
            name="runwayHeading"
            value="55"
            min="0"
            max="360"
            required
          />
        </div>

        <div class="form-control">
          <label for="fieldElevation">Flugplatzhöhe (ft)</label>
          <input
            type="number"
            id="fieldElevation"
            name="fieldElevation"
            value="1535"
            min="0"
            max="15000"
            required
          />
        </div>

        <div class="button-row">
          <button type="button" id="calcBtn">Berechnen</button>
          <button type="button" id="detailsBtn">Detaillierte Berechnung</button>
        </div>
      </form>

      <div id="result"></div>

      <div id="details" class="hidden">
        <p id="isaDeviation">ISA Abweichung: --</p>
        <p id="windComponent">Head/Tailwind Komponente: --</p>
        <p id="calcPressureAltitude">Druckhöhe: --</p>
        <p id="distancePressureAltitude">Strecke nach Druckhöhe (ISA=0): --</p>
        <p id="rollMinus20">Rollstrecke -20: --</p>
        <p id="roll0">Rollstrecke 0: --</p>
        <p id="rollPlus20">Rollstrecke +20: --</p>
        <p id="wMinus20">w_m20: --</p>
        <p id="w0">w_0: --</p>
        <p id="wPlus20">w_p20: --</p>
        <p id="sRoll">S_Roll: --</p>
        <p id="surfaceDistance">Strecke nach Pistenart: --</p>
        <p id="windDistance">Strecke nach Wind: --</p>
      </div>
    </div>

    <aside id="visualization">
      <h2>Grafische Darstellung</h2>
      <div id="windIndicator">
        <div id="windCircle">
          <div id="windArrow"></div>
        </div>
        <p id="relativeWindAngleText">Relativer Windwinkel: --</p>
      </div>
      <div id="runwayContainer">
        <div id="runway"></div>
        <p class="runway-label">Landebahn (senkrecht)</p>
      </div>
    </aside>
  </div>

  <script>
    document.getElementById('calcBtn').addEventListener('click', function () {
      const temperature = parseFloat(document.getElementById('temperature').value) || 0;
      const qnh = parseFloat(document.getElementById('qnh').value) || 0;
      const fieldElevation =
        parseFloat(document.getElementById('fieldElevation').value) || 0;
      const pressureAltitude = (1013 - qnh) * 28 + fieldElevation;
      const windSpeed = parseFloat(document.getElementById('windSpeed').value) || 0;
      const windDirection =
        parseFloat(document.getElementById('windDirection').value) || 0;
      const runwayHeading =
        parseFloat(document.getElementById('runwayHeading').value) || 0;
    const perfForm = document.getElementById('perfForm');
    const resultElement = document.getElementById('result');
    const detailsElement = document.getElementById('details');
    const calcBtn = document.getElementById('calcBtn');
    const detailsBtn = document.getElementById('detailsBtn');
    const surfaceSelect = document.getElementById('surface');
    const windArrowElement = document.getElementById('windArrow');
    const relativeWindAngleText = document.getElementById('relativeWindAngleText');

    function formatNumber(value, fractionDigits = 2) {
      return value.toLocaleString('de-DE', {
        minimumFractionDigits: fractionDigits,
        maximumFractionDigits: fractionDigits,
      });
    }

    function normalizeAngle(angle) {
      return ((angle % 360) + 360) % 360;
    }

    function updateWindVisualization(angle) {
      const normalizedAngle = normalizeAngle(angle);
      const signedAngle = ((angle + 540) % 360) - 180;
      windArrowElement.style.transform = `translate(-50%, -50%) rotate(${normalizedAngle}deg)`;

      let descriptor = 'gerade auf der Piste';
      if (signedAngle > 0) {
        descriptor = `von rechts ${Math.abs(signedAngle).toFixed(0)}\u00B0`;
      } else if (signedAngle < 0) {
        descriptor = `von links ${Math.abs(signedAngle).toFixed(0)}\u00B0`;
      }

      relativeWindAngleText.textContent = `Relativer Windwinkel: ${signedAngle.toFixed(0)}\u00B0 (${descriptor})`;
    }

    function refreshWindVisualizationFromInputs() {
      const windDirectionValue = parseFloat(document.getElementById('windDirection').value);
      const runwayHeadingValue = parseFloat(document.getElementById('runwayHeading').value);

      if (!Number.isFinite(windDirectionValue) || !Number.isFinite(runwayHeadingValue)) {
        updateWindVisualization(0);
        return;
      }

      updateWindVisualization(windDirectionValue - runwayHeadingValue);
    }

    perfForm.querySelectorAll('input[type="number"]').forEach((input) => {
      input.addEventListener('input', function () {
        if (this.value === '') {
          return;
        }

        let numericValue = parseFloat(this.value);
        if (!Number.isFinite(numericValue)) {
          return;
        }

        if (this.min !== '') {
          const min = parseFloat(this.min);
          if (Number.isFinite(min) && numericValue < min) {
            numericValue = min;
          }
        }

        if (this.max !== '') {
          const max = parseFloat(this.max);
          if (Number.isFinite(max) && numericValue > max) {
            numericValue = max;
          }
        }

        this.value = numericValue;

        if (this.id === 'windDirection' || this.id === 'runwayHeading') {
          refreshWindVisualizationFromInputs();
        }
      });
    });

    ['windDirection', 'runwayHeading'].forEach((id) => {
      document.getElementById(id).addEventListener('input', refreshWindVisualizationFromInputs);
    });

    refreshWindVisualizationFromInputs();

    calcBtn.addEventListener('click', () => {
      if (!perfForm.checkValidity()) {
        perfForm.reportValidity();
        return;
      }

      const qnh = parseFloat(document.getElementById('qnh').value);
      const temperature = parseFloat(document.getElementById('temperature').value);
      const windSpeed = parseFloat(document.getElementById('windSpeed').value);
      const windDirection = parseFloat(document.getElementById('windDirection').value);
      const runwayHeading = parseFloat(document.getElementById('runwayHeading').value);
      const fieldElevation = parseFloat(document.getElementById('fieldElevation').value);

      const pressureAltitude = (1013 - qnh) * 28 + fieldElevation;
      const isaDeviation = temperature - (15 - (pressureAltitude / 1000) * 2);
      const relativeWindAngle = windDirection - runwayHeading;
      const windComponent =
        Math.cos(((windDirection - runwayHeading) * Math.PI) / 180) * windSpeed;

      document.getElementById(
        'isaDeviation'
      ).textContent = `ISA Abweichung: ${isaDeviation.toFixed(2)} \u00B0C`;
      document.getElementById(
        'windComponent'
      ).textContent = `Head/Tailwind Komponente: ${windComponent.toFixed(2)} kt`;
      document.getElementById(
        'calcPressureAltitude'
      ).textContent = `Druckhöhe: ${pressureAltitude.toFixed(0)} ft`;
        Math.cos((relativeWindAngle * Math.PI) / 180) * windSpeed;

      updateWindVisualization(relativeWindAngle);

      document.getElementById('isaDeviation').textContent = `ISA Abweichung: ${formatNumber(isaDeviation, 2)} \u00B0C`;
      document.getElementById('windComponent').textContent = `Head/Tailwind Komponente: ${formatNumber(windComponent, 2)} kt`;
      document.getElementById('calcPressureAltitude').textContent = `Druckhöhe: ${formatNumber(pressureAltitude, 0)} ft`;

      const distanceISA0 =
        0.000001339 * pressureAltitude * pressureAltitude +
        0.01854 * pressureAltitude +
        290.7;
      document.getElementById(
        'distancePressureAltitude'
      ).textContent = `Strecke nach Druckhöhe (ISA=0): ${distanceISA0.toFixed(2)} m`;
      document.getElementById('distancePressureAltitude').textContent =
        `Strecke nach Druckhöhe (ISA=0): ${formatNumber(distanceISA0)} m`;

      const rollMinus20 =
        0.0000000011 * Math.pow(pressureAltitude, 4) -
        0.0000017 * Math.pow(pressureAltitude, 3) +
        0.0000755 * Math.pow(pressureAltitude, 2) +
        0.0129 * pressureAltitude +
        245;
      const roll0 =
        -0.00000015 * Math.pow(pressureAltitude, 4) +
        0.0000113 * Math.pow(pressureAltitude, 3) -
        0.000187 * Math.pow(pressureAltitude, 2) +
        0.0248 * pressureAltitude +
        290;
      const rollPlus20 =
        -0.00000034 * Math.pow(pressureAltitude, 4) +
        0.000055 * Math.pow(pressureAltitude, 3) -
        0.000411 * Math.pow(pressureAltitude, 2) +
        0.0319 * pressureAltitude +
        340;

      document.getElementById('rollMinus20').textContent =
        `Rollstrecke -20 = 0.0000000011 * Druckhöhe^4 - 0.0000017 * Druckhöhe^3 + 0.0000755 * Druckhöhe^2 + 0.0129 * Druckhöhe + 245 = ${formatNumber(rollMinus20)} m`;
      document.getElementById('roll0').textContent =
        `Rollstrecke 0 = -0.00000015 * Druckhöhe^4 + 0.0000113 * Druckhöhe^3 - 0.000187 * Druckhöhe^2 + 0.0248 * Druckhöhe + 290 = ${formatNumber(roll0)} m`;
      document.getElementById('rollPlus20').textContent =
        `Rollstrecke +20 = -0.00000034 * Druckhöhe^4 + 0.0000550 * Druckhöhe^3 - 0.000411 * Druckhöhe^2 + 0.0319 * Druckhöhe + 340 = ${formatNumber(rollPlus20)} m`;

      const wMinus20 = (isaDeviation * (isaDeviation - 20)) / 800;
      const w0 = (400 - Math.pow(isaDeviation, 2)) / 400;
      const wPlus20 = (isaDeviation * (isaDeviation + 20)) / 800;

      document.getElementById('wMinus20').textContent =
        `w_m20 = (ISA Abweichung * (ISA Abweichung - 20)) / 800 = ${formatNumber(wMinus20, 4)}`;
      document.getElementById('w0').textContent =
        `w_0 = (400 - ISA Abweichung^2) / 400 = ${formatNumber(w0, 4)}`;
      document.getElementById('wPlus20').textContent =
        `w_p20 = (ISA Abweichung * (ISA Abweichung + 20)) / 800 = ${formatNumber(wPlus20, 4)}`;

      const sRoll = wMinus20 * rollMinus20 + w0 * roll0 + wPlus20 * rollPlus20;
      document.getElementById('sRoll').textContent =
        `S_Roll = w_m20 * Rollstrecke -20 + w_0 * Rollstrecke 0 + w_p20 * Rollstrecke +20 = (${formatNumber(wMinus20, 4)} * ${formatNumber(rollMinus20)}) + (${formatNumber(w0, 4)} * ${formatNumber(roll0)}) + (${formatNumber(wPlus20, 4)} * ${formatNumber(rollPlus20)}) = ${formatNumber(sRoll)} m`;

      const surfaceMultipliers = {
        asphalt: 1.1,
        concrete: 1.1,
        'hard-grass': 1.17,
        'short-grass': 1.2,
        'long-grass': 1.37,
        'short-wet-grass-firm': 1.39,
        'loose-soft': 1.6,
      };

      const surfaceValue = surfaceSelect.value;
      const surfaceMultiplier = surfaceMultipliers[surfaceValue] ?? 1;
      const surfaceLabel = surfaceSelect.options[surfaceSelect.selectedIndex].text;
      const surfaceAdjustedDistance = sRoll * surfaceMultiplier;
      const surfaceMultiplierText = formatNumber(surfaceMultiplier, 2);

      document.getElementById('surfaceDistance').textContent =
        `Strecke nach Pistenart = S_Roll * ${surfaceMultiplierText} (${surfaceLabel}) = ${formatNumber(surfaceAdjustedDistance)} m`;

      const denominator = windComponent > 0 ? 5 : 2.5;
      const denominatorText = windComponent > 0 ? '5' : '2,5';
      const factor = windComponent > 0 ? 0.2 : 0.15;
      const factorText = windComponent > 0 ? '0,2' : '0,15';
      const windMultiplierRaw = 1 - (windComponent / denominator) * factor;
      const windMultiplier = Math.max(0, windMultiplierRaw);
      const windAdjustedDistance = surfaceAdjustedDistance * windMultiplier;
      const windMultiplierText = formatNumber(windMultiplier, 2);
      const surfaceDistanceText = formatNumber(surfaceAdjustedDistance);
      const windAdjustedDistanceText = formatNumber(windAdjustedDistance);
      const componentText = formatNumber(windComponent, 2);
      const symbolicFormula =
        windComponent > 0
          ? 'Strecke nach Pistenart * (1 - ((Head/Tailwind Komponente / 5) * 0,2))'
          : 'Strecke nach Pistenart * (1 - ((Head/Tailwind Komponente / 2,5) * 0,15))';
      const resolvedFormula = `Strecke nach Pistenart * (1 - ((${componentText} / ${denominatorText}) * ${factorText}))`;
      const windNote = windMultiplier === windMultiplierRaw ? '' : ' (auf 0 begrenzt)';

      document.getElementById('windDistance').textContent =
        `Strecke nach Wind: ${symbolicFormula} = ${resolvedFormula} = ${surfaceDistanceText} m * ${windMultiplierText} = ${windAdjustedDistanceText} m${windNote}`;

      const result = document.getElementById('result');
      result.textContent = 'Berechnung abgeschlossen.';
      resultElement.textContent = 'Berechnung abgeschlossen.';
    });

    document.getElementById('detailsBtn').addEventListener('click', function () {
      const details = document.getElementById('details');
      details.style.display = details.style.display === 'none' ? 'block' : 'none';
    detailsBtn.addEventListener('click', () => {
      detailsElement.classList.toggle('hidden');
    });
  </script>
</body>
</html>
